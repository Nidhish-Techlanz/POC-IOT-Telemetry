<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sensor Data Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #007acc;
      --background: #f5f7fa;
      --card: #fff;
      --accent: #ffda79;
    }
    body {
      background: var(--background);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #222;
    }
    .container {
      max-width: 1050px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60, 120, 180, 0.08);
    }
    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 2.5rem;
      letter-spacing: 2px;
      font-size: 2.6rem;
      font-weight: 700;
      text-shadow: 0 2px 10px #cbeaff6b;
    }
    .latest {
      display```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sensor Data Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #007acc;
      --background: #f5f7fa;
      --card: #fff;
      --accent: #ffda79;
    }
    body {
      background: var(--background);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #222;
    }
    .container {
      max-width: 1050px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60, 120, 180, 0.08);
    }
    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 2.5rem;
      letter-spacing: 2px;
      font-size: 2.6rem;
      font-weight: 700;
      text-shadow: 0 2px 10px #cbeaff6b;
    }
    .latest {
      display: flex;
      justify-content: space-evenly;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 2.6rem;
    }
    .metric {
      background: linear-gradient(120deg, #f7fafc 0%, #e9f4ff 100%);
      border-radius: 14px;
      box-shadow: 0 0 12px rgba(90,170,255,0.09);
      padding: 1.3rem 1.8rem;
      min-width: 190px;
      text-align: center;
      flex: 1 1 195px;
    }
    .metric-label {
      font-size: 1.08rem;
      color: #888;
      margin-bottom: 0.4rem;
    }
    .metric-value {
      color: var(--primary);
      font-size: 2.1rem;
      font-weight: 600;
      line-height: 1;
    }
    .metric-unit {
      font-size: 1rem;
      color: #bbb;
      margin-left: 4px;
    }
    .timestamp {
      color: #666;
      font-size: 1.06rem;
      margin-top: 0.4rem;
      letter-spacing: 0.5px;
    }
    .charts {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0.8rem;
    }
    .chart-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 3px 20px rgba(0, 0, 0, 0.07);
      padding: 1.2rem 1.5rem;
      min-width: 320px;
      flex: 1 1 300px;
      margin-bottom: 2.2rem;
    }
    @media (max-width: 900px) {
      .charts {
        flex-direction: column;
        gap: 1.5rem;
      }
    }
    @media (max-width: 700px) {
      .container {
        padding: 1.1rem;
      }
      .latest {
        gap: 1.3rem;
      }
      .chart-card {
        min-width: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sensor Data Hub</h1>
    <div class="latest">
      <div class="metric">
        <div class="metric-label">Timestamp</div>
        <div class="metric-value" id="timestamp">--</div>
      </div>
      <div class="metric">
        <div class="metric-label">CO₂ Level</div>
        <div class="metric-value" id="co2">--<span class="metric-unit">ppm</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">Humidity</div>
        <div class="metric-value" id="humidity">--<span class="metric-unit">%</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">Noise</div>
        <div class="metric-value" id="noise">--<span class="metric-unit">dB</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">Latency</div>
        <div class="metric-value" id="latency">--<span class="metric-unit">s</span></div>
      </div>
    </div>
    <div class="charts">
      <div class="chart-card">
        <div style="font-size:1.13rem; margin-bottom:0.4rem; color:#007acc">CO₂ Level Trend</div>
        <canvas id="co2Chart" height="110"></canvas>
      </div>
      <div class="chart-card">
        <div style="font-size:1.13rem; margin-bottom:0.4rem; color:#007acc">Humidity Trend</div>
        <canvas id="humidityChart" height="110"></canvas>
      </div>
      <div class="chart-card">
        <div style="font-size:1.13rem; margin-bottom:0.4rem; color:#007acc">Noise Level Trend</div>
        <canvas id="noiseChart" height="110"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Helper: create chart configuration for a line chart
    const chartConfig = (label, color) => ({
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: label,
          data: [],
          borderColor: color,
          backgroundColor: color.replace(')', ', 0.09)').replace('rgb', 'rgba'),
          pointRadius: 2.7,
          fill: true,
          tension: 0.22
        }]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: {
            display: true,
            grid: { color: '#f3f3f3' },
          },
          y: {
            display: true,
            grid: { color: '#f4f7fa' },
            beginAtZero: false
          }
        }
      }
    });

    // Create Chart.js chart instances
    const co2Ctx = document.getElementById('co2Chart').getContext('2d');
    const humidityCtx = document.getElementById('humidityChart').getContext('2d');
    const noiseCtx = document.getElementById('noiseChart').getContext('2d');

    const co2Chart = new Chart(co2Ctx, chartConfig('CO₂ (ppm)', 'rgb(59, 144, 224)'));
    const humidityChart = new Chart(humidityCtx, chartConfig('Humidity (%)', 'rgb(255, 179, 79)'));
    const noiseChart = new Chart(noiseCtx, chartConfig('Noise (dB)', 'rgb(81, 193, 95)'));

    const MAX_DATA_POINTS = 24;

    // Open WebSocket connection to backend streaming your MQTT data
    const ws = new WebSocket('ws://localhost:8000');

    ws.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        let payload = data.message;

        // If message is a stringified JSON inside data.message, parse again
        if (typeof payload === 'string') {
          payload = JSON.parse(payload);
        }

        // Extract sensor values
        const ts = payload["server.timestamp"] || payload["timestamp"] || null;
        const co2 = payload["CO2"];
        const humidity = payload["Humidity"];
        const noise = payload["noise"];

        // Update latest metric displays
        document.getElementById('timestamp').textContent = ts !== null ? ts : '--';
        document.getElementById('co2').textContent = co2 !== undefined ? co2 : '--';
        document.getElementById('humidity').textContent = humidity !== undefined ? humidity : '--';
        document.getElementById('noise').textContent = noise !== undefined ? noise : '--';

        // Calculate and update latency
        if (ts !== null && !isNaN(ts)) {
          const clientTimeSec = Date.now() / 1000; // current time in seconds
          let latencySec = clientTimeSec - ts;
          if (latencySec < 0) latencySec = 0; // clamp to 0 if negative (clo0ck skew)
          document.getElementById('latency').textContent = latencySec.toFixed(2);
        } else {
          document.getElementById('latency').textContent = '--';
        }

        // Format time label for charts (convert if UNIX timestamp)
        const timeLabel = typeof ts === 'number'
          ? new Date(ts * 1000).toLocaleTimeString()
          : ts;

        // Update CO2 chart
        if (co2 !== undefined) {
          co2Chart.data.labels.push(timeLabel);
          co2Chart.data.datasets.data.push(co2);
          if (co2Chart.data.labels.length > MAX_DATA_POINTS) {
            co2Chart.data.labels.shift();
            co2Chart.data.datasets.data.shift();
          }
          co2Chart.update();
        }

        // Update Humidity chart
        if (humidity !== undefined) {
          humidityChart.data.labels.push(timeLabel);
          humidityChart.data.datasets.data.push(humidity);
          if (humidityChart.data.labels.length > MAX_DATA_POINTS) {
            humidityChart.data.labels.shift();
            humidityChart.data.datasets.data.shift();
          }
          humidityChart.update();
        }

        // Update Noise chart
        if (noise !== undefined) {
          noiseChart.data.labels.push(timeLabel);
          noiseChart.data.datasets.data.push(noise);
          if (noiseChart.data.labels.length > MAX_DATA_POINTS) {
            noiseChart.data.labels.shift();
            noiseChart.data.datasets.data.shift();
          }
          noiseChart.update();
        }

      } catch (error) {
        console.error('Parsing or update error:', error);
      }
    };
  </script>
</body>
</html>
